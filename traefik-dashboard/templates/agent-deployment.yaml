apiVersion: apps/v1
kind: Deployment
metadata:
  name: traefik-log-dashboard-agent
  namespace: {{ .Values.namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: traefik-log-dashboard-agent
  template:
    metadata:
      labels:
        app: traefik-log-dashboard-agent
    spec:
      containers:
      - name: agent
        image: {{ .Values.agent.image }}
        ports:
          - containerPort: {{ .Values.agent.port }}
        env:
          - name: TRAEFIK_LOG_DASHBOARD_ACCESS_PATH
            value: "{{ .Values.agent.traefikLogsPath }}/access.log"
          - name: TRAEFIK_LOG_DASHBOARD_ERROR_PATH
            value: "{{ .Values.agent.traefikLogsPath }}/access.log"
          - name: TRAEFIK_LOG_DASHBOARD_AUTH_TOKEN
            value: "{{ .Values.agent.authToken }}"
          - name: TRAEFIK_LOG_DASHBOARD_SYSTEM_MONITORING
            value: "true"
          - name: TRAEFIK_LOG_DASHBOARD_GEOIP_ENABLED
            value: "{{ .Values.agent.geoipEnabled | quote }}"
          - name: TRAEFIK_LOG_DASHBOARD_GEOIP_CITY_DB
            value: "/geoip/GeoLite2-City.mmdb"
          - name: TRAEFIK_LOG_DASHBOARD_GEOIP_COUNTRY_DB
            value: "/geoip/GeoLite2-Country.mmdb"
          - name: TRAEFIK_LOG_DASHBOARD_LOG_FORMAT
            value: "{{ .Values.agent.logFormat }}"
          - name: PORT
            value: "{{ .Values.agent.port | quote }}"
        volumeMounts:
          - name: traefik-logs
            mountPath: /logs
            readOnly: true
          - name: geoip
            mountPath: /geoip
          - name: positions
            mountPath: /data
        livenessProbe:
          httpGet:
            path: /api/logs/status
            port: {{ .Values.agent.port }}
          initialDelaySeconds: 30
          periodSeconds: 30
      volumes:
        - name: traefik-logs
          hostPath:
            path: /var/lib/rancher/k3s/server/logs
            type: DirectoryOrCreate
        - name: geoip
          persistentVolumeClaim:
            claimName: traefik-log-dashboard-data
        - name: positions
          persistentVolumeClaim:
            claimName: traefik-log-dashboard-data
